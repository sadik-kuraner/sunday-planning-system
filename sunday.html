<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Sunday Planning System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
</head>

<body>
<div class="container">

  <div class="back-row">
    <a href="index.html" class="back-link">‚Üê Terug naar overzicht</a>
  </div>

  <h2 class="page-title">Sunday Planning System</h2>

  <form id="planning-form">
    <input type="hidden" id="planning-id">

    <div class="form-row">
      <label>From date</label>
      <input type="date" id="planning-from">
    </div>

    <div class="form-row">
      <label>To date</label>
      <input type="date" id="planning-to">
    </div>

    <div class="form-row">
      <label>Mission for this week</label>
      <textarea id="planning-mission"></textarea>
    </div>

    <div class="form-row">
      <label>Goal 1</label>
      <input type="text" id="planning-goal1">
    </div>

    <div class="form-row">
      <label>Goal 2</label>
      <input type="text" id="planning-goal2">
    </div>

    <div class="form-row">
      <label>Goal 3</label>
      <input type="text" id="planning-goal3">
    </div>

    <div class="form-row">
      <label>Devil's vortex</label>
      <textarea id="planning-devils"></textarea>
    </div>

    <div class="form-actions">
      <button type="submit" class="btn btn-primary">Opslaan</button>
      <button type="button" id="print-btn" class="btn btn-secondary">Printen</button>
    </div>

    <p id="save-status" class="form-note"></p>

  </form>

</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="firebase-config.js"></script>

<script>

// --------------------------------------------------
// UTILITIES
// --------------------------------------------------

function generateId() {
  return Math.random().toString(36).slice(2) + Date.now().toString(36);
}

function getQueryParam(name) {
  const params = new URLSearchParams(window.location.search);
  return params.get(name);
}

// --------------------------------------------------
// ELEMENTS
// --------------------------------------------------

const idEl = document.getElementById("planning-id");
const fromEl = document.getElementById("planning-from");
const toEl = document.getElementById("planning-to");
const missionEl = document.getElementById("planning-mission");
const g1El = document.getElementById("planning-goal1");
const g2El = document.getElementById("planning-goal2");
const g3El = document.getElementById("planning-goal3");
const devilsEl = document.getElementById("planning-devils");
const statusEl = document.getElementById("save-status");

// --------------------------------------------------
// LOAD EXISTING PLAN FROM FIRESTORE
// --------------------------------------------------

async function loadPlanIfExists() {
  const id = getQueryParam("id");
  if (!id) return;

  const doc = await db.collection("sunday_plans").doc(id).get();

  if (!doc.exists) return;

  const p = doc.data();

  idEl.value = p.id;
  fromEl.value = p.fromDate || "";
  toEl.value = p.toDate || "";
  missionEl.value = p.mission || "";
  g1El.value = p.goal1 || "";
  g2El.value = p.goal2 || "";
  g3El.value = p.goal3 || "";
  devilsEl.value = p.devilsVortex || "";
}

// --------------------------------------------------
// SAVE PLAN TO FIRESTORE
// --------------------------------------------------

async function savePlan(plan) {
  await db.collection("sunday_plans").doc(plan.id).set(plan);
}

// --------------------------------------------------
// FORM SUBMIT
// --------------------------------------------------

document.getElementById("planning-form").addEventListener("submit", async event => {
  event.preventDefault();

  const fromDate = fromEl.value;
  const toDate = toEl.value;
  const mission = missionEl.value;

  if (!fromDate || !toDate || !mission.trim()) {
    alert("Vul minimaal from date, to date en mission in.");
    return;
  }

  const planId = idEl.value || generateId();

  const plan = {
    id: planId,
    fromDate,
    toDate,
    mission,
    goal1: g1El.value,
    goal2: g2El.value,
    goal3: g3El.value,
    devilsVortex: devilsEl.value,
    createdAt: new Date().toISOString()
  };

  await savePlan(plan);

  idEl.value = planId;
  statusEl.textContent = "Opgeslagen in Firestore. Je kunt deze week later weer openen via het overzicht.";
});

// --------------------------------------------------
// PRINT
// --------------------------------------------------

document.getElementById("print-btn").addEventListener("click", () => {
  window.print();
});

// --------------------------------------------------
// INIT
// --------------------------------------------------

loadPlanIfExists();

</script>

</body>
</html>