<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Weekly Rhythm Register</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
</head>

<body>
<div class="container">

  <div class="back-row">
    <a href="index.html" class="back-link">‚Üê Terug naar overzicht</a>
  </div>

  <h2 class="page-title">Weekly Rhythm Register</h2>

  <form id="rhythm-form">
    <input type="hidden" id="rhythm-id">

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>BEHAVIOR/ACTION</th>
            <th>MON</th>
            <th>TUES</th>
            <th>WEDS</th>
            <th>THURS</th>
            <th>FRI</th>
            <th>SAT</th>
            <th>SUN</th>
            <th>ACHIEVED</th>
            <th>GOAL</th>
            <th>NET</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="rhythm-body"></tbody>

        <tfoot>
          <tr class="total-row">
            <td>TOTAL</td>
            <td></td><td></td><td></td><td></td><td></td><td></td><td></td>
            <td id="total-achieved">0</td>
            <td id="total-goal">0</td>
            <td id="total-net">0</td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <button type="button" id="add-row-btn" class="btn btn-secondary" style="margin-top:12px;">Rij toevoegen</button>

    <div class="date-range-row" style="margin-top:24px;">
      <span>Date Range:</span>
      <input type="date" id="rhythm-from" class="small-date-input">
      <span>‚Äì</span>
      <input type="date" id="rhythm-to" class="small-date-input">
    </div>

    <div class="form-actions">
      <button type="submit" class="btn btn-primary">Opslaan</button>
      <button type="button" id="print-btn" class="btn btn-secondary">Printen</button>
    </div>

    <p class="form-note" id="save-status"></p>
  </form>

</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="firebase-config.js"></script>

<script>

// ------------------------------------------------------------
// Utility
// ------------------------------------------------------------
function computeId(from, to) {
  return `${from}_${to}`;
}

// ------------------------------------------------------------
// Elements
// ------------------------------------------------------------
const bodyEl = document.getElementById("rhythm-body");
const fromEl = document.getElementById("rhythm-from");
const toEl = document.getElementById("rhythm-to");
const idEl = document.getElementById("rhythm-id");
const statusEl = document.getElementById("save-status");

const totalAchievedEl = document.getElementById("total-achieved");
const totalGoalEl = document.getElementById("total-goal");
const totalNetEl = document.getElementById("total-net");

// ------------------------------------------------------------
// Row creation & updates
// ------------------------------------------------------------
function createRow(initial) {
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><input type="text" class="behavior-input" value="${initial?.behavior || ""}"></td>
    <td><input type="checkbox" class="day-mon"></td>
    <td><input type="checkbox" class="day-tues"></td>
    <td><input type="checkbox" class="day-weds"></td>
    <td><input type="checkbox" class="day-thurs"></td>
    <td><input type="checkbox" class="day-fri"></td>
    <td><input type="checkbox" class="day-sat"></td>
    <td><input type="checkbox" class="day-sun"></td>
    <td class="achieved-cell">0</td>
    <td><input type="number" class="goal-cell" min="0" max="7" value="${initial?.goal || 0}"></td>
    <td class="net-cell">0</td>
    <td><button type="button" class="icon-btn delete-row-btn">üóë</button></td>
  `;

  if (initial) {
    tr.querySelector(".day-mon").checked = initial.mon;
    tr.querySelector(".day-tues").checked = initial.tues;
    tr.querySelector(".day-weds").checked = initial.weds;
    tr.querySelector(".day-thurs").checked = initial.thurs;
    tr.querySelector(".day-fri").checked = initial.fri;
    tr.querySelector(".day-sat").checked = initial.sat;
    tr.querySelector(".day-sun").checked = initial.sun;
  }

  tr.querySelectorAll("input[type='checkbox']").forEach(cb => {
    cb.addEventListener("change", () => { updateRow(tr); updateTotals(); });
  });

  tr.querySelector(".goal-cell").addEventListener("input", () => { updateRow(tr); updateTotals(); });

  tr.querySelector(".delete-row-btn").addEventListener("click", () => {
    tr.remove();
    updateTotals();
  });

  updateRow(tr);
  bodyEl.appendChild(tr);
}

function updateRow(tr) {
  const checks = tr.querySelectorAll("input[type='checkbox']");
  let achieved = 0;
  checks.forEach(cb => { if (cb.checked) achieved++; });

  tr.querySelector(".achieved-cell").textContent = achieved;

  const goal = Number(tr.querySelector(".goal-cell").value || 0);
  const net = achieved - goal;

  const netCell = tr.querySelector(".net-cell");
  netCell.textContent = net;
  netCell.classList.toggle("negative", net < 0);
}

function updateTotals() {
  let achieved = 0, goal = 0, net = 0;

  bodyEl.querySelectorAll("tr").forEach(tr => {
    achieved += Number(tr.querySelector(".achieved-cell").textContent || 0);
    goal += Number(tr.querySelector(".goal-cell").value || 0);
    net += Number(tr.querySelector(".net-cell").textContent || 0);
  });

  totalAchievedEl.textContent = achieved;
  totalGoalEl.textContent = goal;
  totalNetEl.textContent = net;
  totalNetEl.classList.toggle("negative", net < 0);
}

// ------------------------------------------------------------
// Load from Firestore
// ------------------------------------------------------------
async function loadIfExists() {
  const from = fromEl.value;
  const to = toEl.value;
  if (!from || !to) return;

  const docId = computeId(from, to);
  idEl.value = docId;

  const doc = await db.collection("rhythms").doc(docId).get();
  if (!doc.exists) return;

  const data = doc.data();

  bodyEl.innerHTML = "";
  (data.rows || []).forEach(r => createRow(r));

  updateTotals();
}

// ------------------------------------------------------------
// Save to Firestore
// ------------------------------------------------------------
async function saveRhythm() {
  const from = fromEl.value;
  const to = toEl.value;

  if (!from || !to) {
    alert("Vul een geldige date range in.");
    return;
  }

  const rows = [];
  bodyEl.querySelectorAll("tr").forEach(tr => {
    const behavior = tr.querySelector(".behavior-input").value.trim();
    if (!behavior) return;

    rows.push({
      behavior,
      mon: tr.querySelector(".day-mon").checked,
      tues: tr.querySelector(".day-tues").checked,
      weds: tr.querySelector(".day-weds").checked,
      thurs: tr.querySelector(".day-thurs").checked,
      fri: tr.querySelector(".day-fri").checked,
      sat: tr.querySelector(".day-sat").checked,
      sun: tr.querySelector(".day-sun").checked,
      goal: Number(tr.querySelector(".goal-cell").value || 0)
    });
  });

  const docId = computeId(from, to);
  idEl.value = docId;

  await db.collection("rhythms").doc(docId).set({
    id: docId,
    fromDate: from,
    toDate: to,
    rows,
    createdAt: new Date().toISOString()
  });

  statusEl.textContent = "Rhythm opgeslagen in Firestore.";
}

// ------------------------------------------------------------
// Listeners
// ------------------------------------------------------------
document.getElementById("add-row-btn").addEventListener("click", () => {
  createRow();
  updateTotals();
});

document.getElementById("rhythm-from").addEventListener("change", loadIfExists);
document.getElementById("rhythm-to").addEventListener("change", loadIfExists);

document.getElementById("rhythm-form").addEventListener("submit", async e => {
  e.preventDefault();
  await saveRhythm();
});

document.getElementById("print-btn").addEventListener("click", () => window.print());

// ------------------------------------------------------------
// Init (blank start row)
// ------------------------------------------------------------
createRow();
updateTotals();

</script>

</body>
</html>